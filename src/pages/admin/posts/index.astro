---
import AdminLayout from '../../layouts/AdminLayout.astro';
export const prerender = false;

const { locals } = Astro;
const db = locals.runtime?.env?.DB;

let posts = [];
if (db) {
  try {
    const result = await db.prepare(`
      SELECT id, slug, title, is_published, pub_date, view_count, created_at
      FROM posts ORDER BY created_at DESC
    `).all();
    posts = result.results || [];
  } catch (e) {
    console.error('DB Error:', e);
  }
}
---

<AdminLayout title="All Posts">
  <div class="posts-page">
    <div class="page-header">
      <h1>All Posts</h1>
      <a href="/admin/posts/new" class="btn-primary">+ New Post</a>
    </div>
    
    <div class="filters">
      <button class="filter-btn active">All ({posts.length})</button>
      <button class="filter-btn">Published ({posts.filter((p: any) => p.is_published).length})</button>
      <button class="filter-btn">Drafts ({posts.filter((p: any) => !p.is_published).length})</button>
    </div>
    
    <div class="posts-list">
      {posts.length === 0 ? (
        <div class="empty-state">
          <p>No posts yet. Create your first post!</p>
          <a href="/admin/posts/new" class="btn-primary">Create Post</a>
        </div>
      ) : (
        posts.map((post: any) => (
          <div class="post-card">
            <div class="post-info">
              <h3>{post.title}</h3>
              <p class="post-meta">
                <span class={`status ${post.is_published ? 'published' : 'draft'}`}>
                  {post.is_published ? 'Published' : 'Draft'}
                </span>
                <span class="date">{new Date(post.pub_date || post.created_at).toLocaleDateString()}</span>
                <span class="views">{post.view_count} views</span>
              </p>
            </div>
            <div class="post-actions">
              <a href={`/admin/posts/edit/${post.id}`} class="btn-edit">Edit</a>
              <a href={`/blog/${post.slug}`} target="_blank" class="btn-view">View</a>
              <button class="btn-delete" data-id={post.id}>Delete</button>
            </div>
          </div>
        ))
      )}
    </div>
  </div>
</AdminLayout>

<style>
  .posts-page { padding: 2rem; }
  
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }
  
  h1 { color: #1a365d; }
  
  .btn-primary {
    background: #d4af37;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
  }
  
  .filters {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }
  
  .filter-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #e2e8f0;
    background: white;
    border-radius: 6px;
    cursor: pointer;
  }
  
  .filter-btn.active {
    background: #1a365d;
    color: white;
    border-color: #1a365d;
  }
  
  .posts-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .post-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  
  .post-info h3 {
    margin-bottom: 0.5rem;
    color: #2d3748;
  }
  
  .post-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    color: #718096;
  }
  
  .status {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  
  .status.published { background: #c6f6d5; color: #276749; }
  .status.draft { background: #feebc8; color: #c05621; }
  
  .post-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .btn-edit, .btn-view, .btn-delete {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.875rem;
    cursor: pointer;
  }
  
  .btn-edit { background: #edf2f7; color: #4a5568; }
  .btn-view { background: #ebf8ff; color: #2b6cb0; }
  .btn-delete { background: #fed7d7; color: #c53030; border: none; }
  
  .empty-state {
    text-align: center;
    padding: 4rem;
    background: white;
    border-radius: 12px;
  }
</style>

<script>
  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const id = (e.target as HTMLElement).dataset.id;
      if (confirm('Are you sure you want to delete this post?')) {
        await fetch(`/api/posts/${id}`, { method: 'DELETE' });
        location.reload();
      }
    });
  });
</script>
