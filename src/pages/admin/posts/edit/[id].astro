---
import AdminLayout from '../../../../layouts/AdminLayout.astro';
export const prerender = false;

const { id } = Astro.params;
const { locals } = Astro;
const db = locals.runtime?.env?.DB;

let post = null;
if (db && id) {
  try {
    post = await db.prepare(`SELECT * FROM posts WHERE id = ?`).bind(id).first();
  } catch (e) {
    console.error('DB Error:', e);
  }
}

if (!post) {
  return Astro.redirect('/admin/posts');
}
---

<AdminLayout title={`Edit: ${post.title}`}>
  <div class="editor-page">
    <div class="page-header">
      <h1>Edit Post</h1>
      <div class="actions">
        <button type="button" class="btn-secondary" id="saveDraft">Save Draft</button>
        <button type="button" class="btn-primary" id="publish">
          {post.is_published ? 'Update' : 'Publish'}
        </button>
      </div>
    </div>

    <form id="postForm" class="post-form">
      <input type="hidden" id="postId" value={id} />

      <div class="form-main">
        <div class="form-group">
          <label for="title">Title</label>
          <input type="text" id="title" name="title" value={post.title} required />
        </div>

        <div class="form-group">
          <label for="slug">Slug</label>
          <input type="text" id="slug" name="slug" value={post.slug} required />
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" rows="3">{post.description}</textarea>
        </div>

        <div class="form-group">
          <label for="content">Content</label>
          <textarea id="content" name="content" rows="20" required>{post.content}</textarea>
        </div>
      </div>

      <div class="form-sidebar">
        <div class="sidebar-card status-card">
          <h3>Status</h3>
          <p class={`status ${post.is_published ? 'published' : 'draft'}`}>
            {post.is_published ? '✓ Published' : '◐ Draft'}
          </p>
          <p class="meta">Views: {post.view_count}</p>
          <p class="meta">Created: {new Date(post.created_at).toLocaleDateString()}</p>
        </div>

        <div class="sidebar-card">
          <h3>Featured Image</h3>
          <div class="form-group">
            <label for="heroImage">Image URL</label>
            <input type="text" id="heroImage" name="heroImage" value={post.hero_image || ''} />
          </div>
          <div class="image-preview" id="imagePreview">
            {post.hero_image && <img src={post.hero_image} alt="Preview" />}
          </div>
        </div>

        <div class="sidebar-card">
          <h3>Author</h3>
          <div class="form-group">
            <input type="text" id="author" name="author" value={post.author} />
          </div>
        </div>

        <div class="sidebar-card danger">
          <h3>Danger Zone</h3>
          <button type="button" class="btn-delete" id="deletePost">Delete Post</button>
        </div>
      </div>
    </form>
  </div>
</AdminLayout>

<style>
  .editor-page { padding: 2rem; }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  h1 { color: #1a365d; }

  .actions { display: flex; gap: 0.75rem; }

  .btn-primary, .btn-secondary {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    border: none;
  }

  .btn-primary { background: #d4af37; color: white; }
  .btn-secondary { background: #edf2f7; color: #4a5568; }

  .post-form {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 2rem;
  }

  .form-main {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    font-weight: 600;
    color: #4a5568;
  }

  .form-group input,
  .form-group textarea {
    padding: 0.75rem 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #d4af37;
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
  }

  .form-group textarea#content {
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 0.875rem;
    line-height: 1.6;
  }

  .form-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .sidebar-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .sidebar-card h3 {
    color: #1a365d;
    margin-bottom: 1rem;
    font-size: 1rem;
  }

  .sidebar-card.danger {
    border: 1px solid #fed7d7;
  }

  .status {
    font-weight: 600;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    display: inline-block;
  }

  .status.published { background: #c6f6d5; color: #276749; }
  .status.draft { background: #feebc8; color: #c05621; }

  .meta { color: #718096; font-size: 0.875rem; margin-top: 0.5rem; }

  .image-preview {
    margin-top: 1rem;
    min-height: 150px;
    background: #f7fafc;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #a0aec0;
  }

  .image-preview img {
    max-width: 100%;
    border-radius: 8px;
  }

  .btn-delete {
    background: #c53030;
    color: white;
    padding: 0.75rem 1rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    width: 100%;
    font-weight: 600;
  }
</style>

<script>
  const postId = (document.getElementById('postId') as HTMLInputElement).value;
  const heroInput = document.getElementById('heroImage') as HTMLInputElement;
  const imagePreview = document.getElementById('imagePreview');

  // Preview image
  heroInput?.addEventListener('change', () => {
    if (heroInput.value && imagePreview) {
      imagePreview.innerHTML = `<img src="${heroInput.value}" alt="Preview" onerror="this.parentElement.innerHTML='Invalid image URL'" />`;
    }
  });

  // Save draft
  document.getElementById('saveDraft')?.addEventListener('click', async () => {
    await updatePost(false);
  });

  // Publish/Update
  document.getElementById('publish')?.addEventListener('click', async () => {
    await updatePost(true);
  });

  // Delete
  document.getElementById('deletePost')?.addEventListener('click', async () => {
    if (confirm('Are you sure you want to delete this post? This cannot be undone.')) {
      const res = await fetch(`/api/posts/${postId}`, { method: 'DELETE' });
      if (res.ok) {
        window.location.href = '/admin/posts';
      }
    }
  });

  async function updatePost(publish: boolean) {
    const form = document.getElementById('postForm') as HTMLFormElement;
    const formData = new FormData(form);

    const data = {
      title: formData.get('title'),
      slug: formData.get('slug'),
      description: formData.get('description'),
      content: formData.get('content'),
      hero_image: formData.get('heroImage'),
      author: formData.get('author'),
      is_published: publish
    };

    try {
      const response = await fetch(`/api/posts/${postId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        alert(publish ? 'Post updated!' : 'Draft saved!');
        window.location.reload();
      } else {
        const error = await response.json();
        alert('Error: ' + error.error);
      }
    } catch (e) {
      alert('Failed to update post');
    }
  }
</script>
