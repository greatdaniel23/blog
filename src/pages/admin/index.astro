---
import AdminLayout from '../../layouts/AdminLayout.astro';
export const prerender = false;

const { locals } = Astro;
const db = locals.runtime?.env?.DB;

let posts = [];
let stats = { posts: 0, subscribers: 0, comments: 0, contacts: 0 };

if (db) {
  try {
    const postsResult = await db.prepare(`
      SELECT id, slug, title, is_published, pub_date, view_count
      FROM posts ORDER BY created_at DESC LIMIT 10
    `).all();
    posts = postsResult.results || [];

    const statsResult = await db.prepare(`
      SELECT
        (SELECT COUNT(*) FROM posts) as posts,
        (SELECT COUNT(*) FROM subscribers WHERE is_active = 1) as subscribers,
        (SELECT COUNT(*) FROM comments WHERE is_approved = 0) as comments,
        (SELECT COUNT(*) FROM contact_submissions WHERE is_read = 0) as contacts
    `).first();
    stats = statsResult || stats;
  } catch (e) {
    console.error('DB Error:', e);
  }
}
---

<AdminLayout title="Dashboard">
  <div class="dashboard">
    <h1>Dashboard</h1>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total Posts</h3>
        <p class="stat-number">{stats.posts}</p>
      </div>
      <div class="stat-card">
        <h3>Subscribers</h3>
        <p class="stat-number">{stats.subscribers}</p>
      </div>
      <div class="stat-card">
        <h3>Pending Comments</h3>
        <p class="stat-number">{stats.comments}</p>
      </div>
      <div class="stat-card">
        <h3>Unread Messages</h3>
        <p class="stat-number">{stats.contacts}</p>
      </div>
    </div>

    <div class="recent-posts">
      <div class="section-header">
        <h2>Recent Posts</h2>
        <a href="/admin/posts/new" class="btn-primary">+ New Post</a>
      </div>

      <table class="posts-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Status</th>
            <th>Views</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {posts.length === 0 ? (
            <tr><td colspan="4" class="empty">No posts yet</td></tr>
          ) : (
            posts.map((post: any) => (
              <tr>
                <td>{post.title}</td>
                <td>
                  <span class={`status ${post.is_published ? 'published' : 'draft'}`}>
                    {post.is_published ? 'Published' : 'Draft'}
                  </span>
                </td>
                <td>{post.view_count}</td>
                <td class="actions">
                  <a href={`/admin/posts/edit/${post.id}`}>Edit</a>
                  <a href={`/blog/${post.slug}`} target="_blank">View</a>
                </td>
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  </div>
</AdminLayout>

<style>
  .dashboard { padding: 2rem; }
  h1 { color: #1a365d; margin-bottom: 2rem; }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  .stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .stat-card h3 {
    color: #718096;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }

  .stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: #1a365d;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .btn-primary {
    background: #d4af37;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
  }

  .posts-table {
    width: 100%;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .posts-table th,
  .posts-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
  }

  .posts-table th {
    background: #f7fafc;
    font-weight: 600;
    color: #4a5568;
  }

  .status {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .status.published { background: #c6f6d5; color: #276749; }
  .status.draft { background: #feebc8; color: #c05621; }

  .actions a {
    margin-right: 1rem;
    color: #4299e1;
    text-decoration: none;
  }

  .empty { text-align: center; color: #a0aec0; }
</style>
