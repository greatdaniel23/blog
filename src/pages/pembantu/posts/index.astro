---
import { getSession } from "../../../lib/auth";

const { env } = Astro.locals.runtime;
const { user } = await getSession(Astro.cookies, env?.DB);

if (!user) {
  return Astro.redirect("/pembantu/login");
}

let posts: any[] = [];
if (env?.DB) {
  const result = await env.DB.prepare(
    "SELECT * FROM posts ORDER BY created_at DESC",
  ).all();
  posts = result.results || [];
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Posts | Alpha Admin</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/pembantu/dashboard.css" />
  </head>
  <body>
    <!-- Top Admin Bar -->
    <div class="wp-admin-bar">
      <div class="wp-admin-bar-left">
        <span class="wp-admin-bar-logo">Alpha Admin</span>
      </div>
      <div class="wp-admin-bar-right">
        <span class="wp-admin-bar-user">Howdy, {user.name}</span>
        <a href="/" target="_blank" class="wp-admin-bar-link">
          <span class="material-symbols-outlined" style="font-size: 18px;"
            >open_in_new</span
          >
        </a>
        <button
          id="logout-btn"
          class="wp-admin-bar-link"
          style="background: none; border: none; cursor: pointer;"
        >
          <span class="material-symbols-outlined" style="font-size: 18px;"
            >logout</span
          >
        </button>
      </div>
    </div>

    <!-- Sidebar Navigation -->
    <nav class="wp-sidebar">
      <ul class="wp-sidebar-menu">
        <li class="wp-sidebar-item">
          <a href="/pembantu" class="wp-sidebar-link">
            <span class="material-symbols-outlined wp-sidebar-icon"
              >dashboard</span
            >
            <span>Dashboard</span>
          </a>
        </li>
        <li class="wp-sidebar-item">
          <a href="/pembantu/posts" class="wp-sidebar-link active">
            <span class="material-symbols-outlined wp-sidebar-icon"
              >article</span
            >
            <span>Posts</span>
          </a>
        </li>
        <li class="wp-sidebar-item">
          <a href="/pembantu/gallery" class="wp-sidebar-link">
            <span class="material-symbols-outlined wp-sidebar-icon"
              >photo_library</span
            >
            <span>Gallery</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- Main Content -->
    <div class="wp-wrap">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"
      >
        <h1 class="wp-heading" style="margin: 0;">Posts</h1>
        <a href="/pembantu/posts/new" class="wp-button">
          <span
            class="material-symbols-outlined"
            style="font-size: 18px; vertical-align: middle; margin-right: 4px;"
            >add</span
          >
          Add New
        </a>
      </div>

      <!-- Posts Table -->
      <div class="wp-table-container">
        <table class="wp-table">
          <thead>
            <tr>
              <th style="width: 100px;">Status</th>
              <th>Title</th>
              <th style="width: 200px;">Slug</th>
              <th class="column-right" style="width: 120px;">Date</th>
              <th class="column-right" style="width: 80px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {
              posts.map((post: any) => (
                <tr>
                  <td>
                    <span
                      class={`wp-badge ${post.is_published ? "wp-badge-success" : "wp-badge-draft"}`}
                    >
                      {post.is_published ? "Published" : "Draft"}
                    </span>
                  </td>
                  <td>
                    <a
                      href={`/pembantu/posts/edit/${post.id}`}
                      style="font-weight: 600;"
                    >
                      {post.title}
                    </a>
                  </td>
                  <td class="text-muted">{post.slug}</td>
                  <td class="column-right text-muted">
                    {new Date(post.created_at).toLocaleDateString()}
                  </td>
                  <td class="column-right">
                    <a
                      href={`/pembantu/posts/edit/${post.id}`}
                      style="margin-right: 8px;"
                      title="Edit"
                    >
                      <span
                        class="material-symbols-outlined"
                        style="font-size: 18px; vertical-align: middle;"
                      >
                        edit
                      </span>
                    </a>
                    <button
                      onclick={`deletePost(${post.id})`}
                      style="background: none; border: none; cursor: pointer; color: var(--error); padding: 0;"
                      title="Delete"
                    >
                      <span
                        class="material-symbols-outlined"
                        style="font-size: 18px; vertical-align: middle;"
                      >
                        delete
                      </span>
                    </button>
                  </td>
                </tr>
              ))
            }
            {
              posts.length === 0 && (
                <tr>
                  <td
                    colspan="5"
                    style="text-align: center; padding: 3rem; color: #787c82;"
                  >
                    No posts found.{" "}
                    <a href="/pembantu/posts/new">Create your first post</a>.
                  </td>
                </tr>
              )
            }
          </tbody>
        </table>
      </div>
    </div>

    <script>
      document
        .getElementById("logout-btn")
        ?.addEventListener("click", async () => {
          await fetch("/api/auth/logout", { method: "POST" });
          window.location.href = "/pembantu/login";
        });

      async function deletePost(id) {
        if (!confirm("Are you sure you want to delete this post?")) return;

        try {
          const response = await fetch(`/api/pembantu/posts/${id}`, {
            method: "DELETE",
          });

          if (response.ok) {
            window.location.reload();
          } else {
            alert("Failed to delete post");
          }
        } catch (error) {
          alert("Error deleting post");
        }
      }
    </script>
  </body>
</html>
