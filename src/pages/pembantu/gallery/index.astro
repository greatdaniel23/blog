---
import { getSession } from "../../../lib/auth";

const { env } = Astro.locals.runtime;
const { user } = await getSession(Astro.cookies, env?.DB);

if (!user) {
    return Astro.redirect("/pembantu/login");
}

let images: any[] = [];
if (env?.DB) {
    const result = await env.DB.prepare(
        "SELECT * FROM gallery ORDER BY created_at DESC",
    ).all();
    images = result.results || [];
}
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Gallery | Alpha Admin</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="/pembantu/dashboard.css" />
    </head>
    <body>
        <!-- Top Admin Bar -->
        <div class="wp-admin-bar">
            <div class="wp-admin-bar-left">
                <span class="wp-admin-bar-logo">Alpha Admin</span>
            </div>
            <div class="wp-admin-bar-right">
                <span class="wp-admin-bar-user">Howdy, {user.name}</span>
                <a href="/" target="_blank" class="wp-admin-bar-link">
                    <span
                        class="material-symbols-outlined"
                        style="font-size: 18px;">open_in_new</span
                    >
                </a>
                <button
                    id="logout-btn"
                    class="wp-admin-bar-link"
                    style="background: none; border: none; cursor: pointer;"
                >
                    <span
                        class="material-symbols-outlined"
                        style="font-size: 18px;">logout</span
                    >
                </button>
            </div>
        </div>

        <!-- Sidebar Navigation -->
        <nav class="wp-sidebar">
            <ul class="wp-sidebar-menu">
                <li class="wp-sidebar-item">
                    <a href="/pembantu" class="wp-sidebar-link">
                        <span class="material-symbols-outlined wp-sidebar-icon"
                            >dashboard</span
                        >
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="wp-sidebar-item">
                    <a href="/pembantu/posts" class="wp-sidebar-link">
                        <span class="material-symbols-outlined wp-sidebar-icon"
                            >article</span
                        >
                        <span>Posts</span>
                    </a>
                </li>
                <li class="wp-sidebar-item">
                    <a href="/pembantu/gallery" class="wp-sidebar-link active">
                        <span class="material-symbols-outlined wp-sidebar-icon"
                            >photo_library</span
                        >
                        <span>Gallery</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <div class="wp-wrap">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"
            >
                <h1 class="wp-heading" style="margin: 0;">Media Library</h1>
                <button id="upload-btn" class="wp-button">
                    <span
                        class="material-symbols-outlined"
                        style="font-size: 18px; vertical-align: middle; margin-right: 4px;"
                        >cloud_upload</span
                    >
                    Add New
                </button>
            </div>

            <!-- Upload Area (Hidden by default or toggled) -->
            <div id="upload-area" class="wp-form-box" style="display: none;">
                <h3 class="wp-heading" style="font-size: 18px; margin-top: 0;">
                    Upload New Images
                </h3>
                <div
                    id="drop-zone"
                    style="border: 2px dashed #c3c4c7; padding: 20px; text-align: center; cursor: pointer; margin-bottom: 15px;"
                >
                    <p>Drag & Drop files here or click to select</p>
                    <input
                        type="file"
                        id="file-input"
                        multiple
                        accept="image/*"
                        style="display: none;"
                    />
                    <button
                        type="button"
                        class="wp-button-secondary"
                        onclick="document.getElementById('file-input').click()"
                        >Select Files</button
                    >
                    <div
                        id="file-list"
                        style="margin-top: 10px; font-size: 13px; text-align: left;"
                    >
                    </div>
                </div>

                <div class="wp-form-actions">
                    <button
                        type="button"
                        id="start-upload"
                        class="wp-button"
                        disabled>Start Upload</button
                    >
                    <button
                        type="button"
                        id="cancel-upload"
                        class="wp-button-secondary">Cancel</button
                    >
                </div>
            </div>

            <!-- Gallery Grid -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;"
            >
                {
                    images.map((img: any) => (
                        <div class="wp-widget" style="margin: 0;">
                            <div style="aspect-ratio: 16/9; overflow: hidden; background: #f0f0f1; border-bottom: 1px solid var(--wp-border);">
                                <img
                                    src={img.image_url}
                                    alt={img.caption || "Gallery Image"}
                                    style="width: 100%; height: 100%; object-fit: cover;"
                                />
                            </div>
                            <div
                                class="wp-widget-body"
                                style="font-size: 12px; padding: 8px;"
                            >
                                <div style="margin-bottom: 4px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    {img.caption || "No Caption"}
                                </div>
                                <div style="color: var(--gray-700); font-size: 11px;">
                                    {new Date(
                                        img.created_at,
                                    ).toLocaleDateString()}
                                </div>
                                <div style="margin-top: 8px; display: flex; justify-content: flex-end;">
                                    <button
                                        onclick={`deleteImage(${img.id})`}
                                        style="color: var(--error); background: none; border: none; cursor: pointer; font-size: 12px;"
                                    >
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    ))
                }
                {
                    images.length === 0 && (
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray-700); background: #fff; border: 1px solid var(--wp-border);">
                            <span
                                class="material-symbols-outlined"
                                style="font-size: 48px; color: var(--gray-300); margin-bottom: 10px; display: block;"
                            >
                                photo_library
                            </span>
                            No images found in the gallery.
                        </div>
                    )
                }
            </div>
        </div>

        <script>
            // Logout Script
            document
                .getElementById("logout-btn")
                ?.addEventListener("click", async () => {
                    await fetch("/api/auth/logout", { method: "POST" });
                    window.location.href = "/pembantu/login";
                });

            // Upload Toggle Scripts
            const uploadBtn = document.getElementById("upload-btn");
            const uploadArea = document.getElementById("upload-area");
            const cancelUpload = document.getElementById("cancel-upload");

            uploadBtn?.addEventListener("click", () => {
                if (uploadArea) uploadArea.style.display = "block";
            });

            cancelUpload?.addEventListener("click", () => {
                if (uploadArea) uploadArea.style.display = "none";
            });

            // Delete Script
            // Upload Logic
            const dropZone = document.getElementById("drop-zone");
            const fileInput = document.getElementById("file-input");
            const fileList = document.getElementById("file-list");
            const startUploadBtn = document.getElementById("start-upload");
            let selectedFiles = [];

            // Drag & Drop
            dropZone?.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropZone.style.borderColor = "#0073aa";
            });

            dropZone?.addEventListener("dragleave", (e) => {
                e.preventDefault();
                dropZone.style.borderColor = "#c3c4c7";
            });

            dropZone?.addEventListener("drop", (e) => {
                e.preventDefault();
                dropZone.style.borderColor = "#c3c4c7";
                if (e.dataTransfer?.files) {
                    handleFiles(e.dataTransfer.files);
                }
            });

            fileInput?.addEventListener("change", (e) => {
                if (e.target.files) handleFiles(e.target.files);
            });

            function handleFiles(files) {
                selectedFiles = [...selectedFiles, ...Array.from(files)];
                updateFileList();
            }

            function updateFileList() {
                if (!fileList || !startUploadBtn) return;
                fileList.innerHTML = selectedFiles
                    .map((f) => `<div>â€¢ ${f.name}</div>`)
                    .join("");
                startUploadBtn.disabled = selectedFiles.length === 0;
            }

            startUploadBtn?.addEventListener("click", async () => {
                if (selectedFiles.length === 0) return;
                startUploadBtn.textContent = "Uploading...";
                startUploadBtn.disabled = true;

                const formData = new FormData();
                selectedFiles.forEach((file) => {
                    formData.append("images", file);
                });

                try {
                    const response = await fetch(
                        "/api/pembantu/gallery/upload",
                        {
                            method: "POST",
                            body: formData,
                        },
                    );

                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert("Upload failed");
                        startUploadBtn.textContent = "Start Upload";
                        startUploadBtn.disabled = false;
                    }
                } catch (error) {
                    console.error(error);
                    alert("Error during upload");
                    startUploadBtn.textContent = "Start Upload";
                    startUploadBtn.disabled = false;
                }
            });

            // Delete Script
            window.deleteImage = async (id) => {
                if (!confirm("Are you sure you want to delete this image?"))
                    return;

                try {
                    const response = await fetch(
                        `/api/pembantu/gallery/${id}`,
                        {
                            method: "DELETE",
                        },
                    );

                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert("Failed to delete image");
                    }
                } catch (error) {
                    alert("Error deleting image");
                }
            };
        </script>
    </body>
</html>
